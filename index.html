<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squares - Exercice de Discipline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', Arial, sans-serif;
            background: #008080;
            padding: 20px;
            color: #000;
        }

        .window {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            max-width: 900px;
            margin: 0 auto;
        }

        .title-bar {
            background: linear-gradient(to right, #000080, #1084d0);
            color: white;
            padding: 3px 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-text {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lang-button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 10px;
        }

        .lang-button:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        .content {
            padding: 20px;
            background: #c0c0c0;
        }

        .tab-container {
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: -2px;
        }

        .tab {
            padding: 5px 15px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 transparent #ffffff;
            cursor: pointer;
            position: relative;
            top: 2px;
        }

        .tab.active {
            background: #c0c0c0;
            border-bottom-color: #c0c0c0;
            z-index: 1;
        }

        .tab-content {
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 15px;
            background: #c0c0c0;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            padding: 8px 20px;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial;
            font-size: 11px;
            margin: 5px;
        }

        .button:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        h2 {
            font-size: 14px;
            margin-bottom: 10px;
            padding: 3px;
            background: #000080;
            color: white;
        }

        h3 {
            font-size: 12px;
            margin: 10px 0 5px 0;
        }

        ul {
            margin-left: 20px;
            font-size: 11px;
            line-height: 1.6;
        }

        .grid-container {
            display: inline-block;
            background: white;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 10px;
            margin: 10px 0;
            max-width: 100%;
            overflow-x: auto;
        }

        .grid {
            display: grid;
            gap: 0;
            background: white;
            border: 1px solid #000;
        }

        .cell {
            width: 25px;
            height: 25px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
            color: #000;
        }

        .cell.next {
            background: #ffffcc;
        }

        .cell.filled {
            background: #e0ffe0;
            cursor: zoom-in;
        }

        .cell.center-line {
            border-right: 2px solid #ff0000;
        }

        .cell.touching {
            background: #ffeeee;
        }

        .drawing-canvas {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 4px solid #000080;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 10px;
        }

        .drawing-canvas.active {
            display: block;
        }

        .canvas-wrapper {
            background: white;
            border: 2px solid #000;
        }

        canvas {
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-controls {
            margin-top: 10px;
            text-align: center;
        }

        .controls {
            margin: 15px 0;
            padding: 10px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
        }

        .status-bar {
            background: #c0c0c0;
            border-top: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            padding: 3px 5px;
            font-size: 11px;
            display: flex;
            gap: 10px;
        }

        .status-section {
            border: 1px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 2px 5px;
        }

        input[type="text"] {
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 3px;
            font-family: 'MS Sans Serif', Arial;
        }

        input[type="text"]::placeholder {
            color: #808080;
            font-style: italic;
        }

        .zoom-viewer {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 4px solid #000080;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            z-index: 3000;
            padding: 15px;
        }

        .zoom-viewer.active {
            display: block;
        }

        .zoom-viewer-title {
            background: #000080;
            color: white;
            padding: 5px 10px;
            margin: -15px -15px 10px -15px;
            font-weight: bold;
        }

        .zoom-viewer canvas {
            border: 2px solid #000;
            display: block;
        }

        .zoom-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2999;
        }

        .zoom-overlay.active {
            display: block;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .window {
                border: none;
                box-shadow: none;
            }
            .title-bar, .tabs, .controls, .status-bar, .button {
                display: none !important;
            }
            .tab-content {
                border: none;
                padding: 0;
            }
            .grid {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="window">
        <div class="title-bar">
            <div class="title-text">
                <span>üìã</span>
                <span id="appTitle">Squares - Exercice de Discipline</span>
            </div>
            <button class="lang-button" onclick="toggleLanguage()">
                <span id="langButton">üá¨üáß EN</span>
            </button>
        </div>

        <div class="content">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('rules')">üìñ R√®gles</div>
                    <div class="tab" onclick="switchTab('practice')">‚úèÔ∏è Pratiquer</div>
                    <div class="tab" onclick="switchTab('print')">üñ®Ô∏è Imprimer</div>
                </div>

                <div id="rules" class="tab-content active">
                    <h2>üìã Principe de l'exercice "Squares"</h2>
                    <p style="font-size: 11px; margin: 10px 0;">
                        Le "Square" est un exercice de concentration, patience et discipline consistant √† remplir une feuille quadrill√©e avec une lettre ou un chiffre par case, sans jamais toucher les lignes.
                    </p>

                    <h3>üéØ Objectif</h3>
                    <ul>
                        <li>D√©velopper la patience et la concentration</li>
                        <li>Maintenir une √©criture r√©guli√®re et soign√©e</li>
                        <li>Exercice de contr√¥le de soi et d'ob√©issance</li>
                        <li>Peut √™tre utilis√© comme punition ou exercice de discipline</li>
                    </ul>

                    <h3>üìè R√®gles strictes</h3>
                    <ul>
                        <li><strong>Support :</strong> Feuille A4 quadrill√©e (carr√©s < 8mm)</li>
                        <li><strong>√âcriture :</strong> Lettres CAPITALES uniquement</li>
                        <li><strong>Placement :</strong> Une lettre/chiffre par case, centr√©e</li>
                        <li><strong>Interdiction absolue :</strong> Ne JAMAIS toucher les lignes</li>
                        <li><strong>Ligne centrale :</strong> Une ligne verticale color√©e peut s√©parer la feuille en deux</li>
                        <li><strong>Tol√©rance :</strong> Z√âRO faute accept√©e</li>
                        <li><strong>Remplissage :</strong> TOUTE la page doit √™tre remplie (pas d'espaces)</li>
                        <li><strong>En cas d'erreur :</strong> Barrer et recommencer la page enti√®re</li>
                    </ul>

                    <h3>‚è±Ô∏è Dur√©e estim√©e</h3>
                    <ul>
                        <li>Environ 1 heure par feuille A4 compl√®te</li>
                        <li>N√©cessite une attention soutenue sans rel√¢chement</li>
                    </ul>

                    <h3>‚ö†Ô∏è Points d'attention</h3>
                    <ul>
                        <li>V√©rifier chaque lettre avant de passer √† la suivante</li>
                        <li>Maintenir une taille et un style constants</li>
                        <li>Rester calme et concentr√© du d√©but √† la fin</li>
                        <li>Accepter de recommencer en cas d'erreur</li>
                        <li>Le texte se r√©p√®te jusqu'√† remplir toute la page</li>
                    </ul>
                </div>

                <div id="practice" class="tab-content">
                    <h2>‚úèÔ∏è Mode Pratique (Digital)</h2>
                    <p style="font-size: 11px; margin: 10px 0;">
                        Cliquez sur une case pour l'agrandir et dessinez votre lettre avec la souris ou le doigt. Vous devez remplir TOUTE la page. Le texte se r√©p√®te automatiquement jusqu'√† la fin.
                    </p>

                    <div class="controls">
                        <label>Texte √† √©crire: </label>
                        <input type="text" id="textInput" placeholder="JE SERAI PLUS ATTENTIF" value="" style="width: 300px;">
                        <button class="button" onclick="startExercise()">Commencer</button>
                        <button class="button" onclick="resetGrid()">R√©initialiser</button>
                    </div>

                    <div class="grid-container">
                        <div id="practiceGrid" class="grid"></div>
                    </div>

                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Instructions:</strong> Cliquez sur la case jaune pour l'agrandir. Dessinez votre lettre capitale en restant dans les limites (bordure rouge). Validez pour continuer. Cliquez sur une case verte pour zoomer et voir la lettre.
                    </div>
                </div>

                <div class="drawing-canvas" id="drawingCanvas">
                    <div style="background: #000080; color: white; padding: 5px; margin-bottom: 10px;">
                        <strong>Dessinez la lettre: <span id="expectedLetter"></span></strong>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="drawCanvas" width="300" height="300"></canvas>
                    </div>
                    <div class="canvas-controls">
                        <button class="button" onclick="clearCanvas()">Effacer</button>
                        <button class="button" onclick="validateDrawing()">Valider</button>
                        <button class="button" onclick="cancelDrawing()">Annuler</button>
                    </div>
                </div>

                <div class="zoom-overlay" id="zoomOverlay" onclick="closeZoomViewer()"></div>
                <div class="zoom-viewer" id="zoomViewer">
                    <div class="zoom-viewer-title">üîç Vue agrandie</div>
                    <canvas id="zoomCanvas" width="400" height="400"></canvas>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="button" onclick="closeZoomViewer()">Fermer</button>
                    </div>
                </div>

                <div id="print" class="tab-content">
                    <h2>üñ®Ô∏è Imprimer une feuille vierge</h2>
                    <p style="font-size: 11px; margin: 10px 0;">
                        Imprimez cette grille normalis√©e pour r√©aliser l'exercice √† la main.
                    </p>

                    <div class="controls">
                        <label>Taille de la grille (carr√©s de 7mm): </label>
                        <select id="gridSize">
                            <option value="small">Petite (15x20)</option>
                            <option value="medium" selected>Moyenne (20x27)</option>
                            <option value="large">Grande (25x35)</option>
                        </select>
                        <button class="button" onclick="generatePrintGrid()">G√©n√©rer</button>
                        <button class="button" onclick="window.print()">Imprimer</button>
                    </div>

                    <div class="grid-container">
                        <div id="printGrid" class="grid"></div>
                    </div>

                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Note:</strong> La ligne rouge centrale est optionnelle. Vous pouvez la tracer au marqueur apr√®s impression.
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-section">Pr√™t</div>
            <div class="status-section" id="statusText">Aucun exercice en cours</div>
            <div class="status-section" id="errorCount">Erreurs: 0</div>
        </div>
    </div>

    <script>
        let currentCell = null;
        let exerciseText = '';
        let currentIndex = 0;
        let errorCount = 0;
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let totalCells = 0;
        const GRID_ROWS = 20;
        const GRID_COLS = 27;
        let currentLang = 'fr';

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        const translations = {
            fr: {
                appTitle: "Squares - Exercice de Discipline",
                tabRules: "üìñ R√®gles",
                tabPractice: "‚úèÔ∏è Pratiquer",
                tabPrint: "üñ®Ô∏è Imprimer",
                rulesTitle: "üìã Principe de l'exercice \"Squares\"",
                rulesIntro: "Le \"Square\" est un exercice de concentration, patience et discipline consistant √† remplir une feuille quadrill√©e avec une lettre ou un chiffre par case, sans jamais toucher les lignes.",
                objective: "üéØ Objectif",
                objectiveItems: [
                    "D√©velopper la patience et la concentration",
                    "Maintenir une √©criture r√©guli√®re et soign√©e",
                    "Exercice de contr√¥le de soi et d'ob√©issance",
                    "Peut √™tre utilis√© comme punition ou exercice de discipline"
                ],
                strictRules: "üìè R√®gles strictes",
                strictRulesItems: [
                    "<strong>Support :</strong> Feuille A4 quadrill√©e (carr√©s < 8mm)",
                    "<strong>√âcriture :</strong> Lettres CAPITALES uniquement",
                    "<strong>Placement :</strong> Une lettre/chiffre par case, centr√©e",
                    "<strong>Interdiction absolue :</strong> Ne JAMAIS toucher les lignes",
                    "<strong>Ligne centrale :</strong> Une ligne verticale color√©e peut s√©parer la feuille en deux",
                    "<strong>Tol√©rance :</strong> Z√âRO faute accept√©e",
                    "<strong>Remplissage :</strong> TOUTE la page doit √™tre remplie (pas d'espaces)",
                    "<strong>En cas d'erreur :</strong> Barrer et recommencer la page enti√®re"
                ],
                duration: "‚è±Ô∏è Dur√©e estim√©e",
                durationItems: [
                    "Environ 1 heure par feuille A4 compl√®te",
                    "N√©cessite une attention soutenue sans rel√¢chement"
                ],
                attention: "‚ö†Ô∏è Points d'attention",
                attentionItems: [
                    "V√©rifier chaque lettre avant de passer √† la suivante",
                    "Maintenir une taille et un style constants",
                    "Rester calme et concentr√© du d√©but √† la fin",
                    "Accepter de recommencer en cas d'erreur",
                    "Le texte se r√©p√®te jusqu'√† remplir toute la page"
                ],
                practiceTitle: "‚úèÔ∏è Mode Pratique (Digital)",
                practiceIntro: "Cliquez sur une case pour l'agrandir et dessinez votre lettre avec la souris ou le doigt. Vous devez remplir TOUTE la page. Le texte se r√©p√®te automatiquement jusqu'√† la fin.",
                practiceInstructions: "<strong>Instructions:</strong> Cliquez sur la case jaune pour l'agrandir. Dessinez votre lettre capitale en restant dans les limites (bordure rouge). Validez pour continuer. Cliquez sur une case verte pour zoomer et voir la lettre.",
                textLabel: "Texte √† √©crire:",
                textPlaceholder: "JE SERAI PLUS ATTENTIF",
                startButton: "Commencer",
                resetButton: "R√©initialiser",
                drawLetter: "Dessinez la lettre:",
                eraseButton: "Effacer",
                validateButton: "Valider",
                cancelButton: "Annuler",
                zoomTitle: "üîç Vue agrandie",
                zoomCloseBtn: "Fermer",
                printTitle: "üñ®Ô∏è Imprimer une feuille vierge",
                printIntro: "Imprimez cette grille normalis√©e pour r√©aliser l'exercice √† la main.",
                printNote: "<strong>Note:</strong> La ligne rouge centrale est optionnelle. Vous pouvez la tracer au marqueur apr√®s impression.",
                gridSize: "Taille de la grille (carr√©s de 7mm):",
                small: "Petite (15x20)",
                medium: "Moyenne (20x27)",
                large: "Grande (25x35)",
                generateButton: "G√©n√©rer",
                printButton: "Imprimer",
                statusReady: "Pr√™t",
                statusNoExercise: "Aucun exercice en cours",
                statusInProgress: "Exercice en cours - Remplissez toute la page",
                statusProgress: "Progression:",
                errors: "Erreurs:",
                cells: "cases",
                errorBorder: "‚ö†Ô∏è ERREUR: Votre lettre touche les bords rouges!\n\nVous devez recommencer la page enti√®re.",
                completionMessage: "‚úÖ FIN\n\nF√©licitations! Toute la page est remplie!",
                fillOrder: "Vous devez remplir les cases dans l'ordre !",
                startFirst: "Veuillez d'abord cliquer sur \"Commencer\"",
                enterText: "Veuillez entrer un texte √† √©crire"
            },
            en: {
                appTitle: "Squares - Discipline Exercise",
                tabRules: "üìñ Rules",
                tabPractice: "‚úèÔ∏è Practice",
                tabPrint: "üñ®Ô∏è Print",
                rulesTitle: "üìã \"Squares\" Exercise Principle",
                rulesIntro: "The \"Square\" is a concentration, patience and discipline exercise consisting of filling a grid sheet with one letter or number per cell, without ever touching the lines.",
                objective: "üéØ Objective",
                objectiveItems: [
                    "Develop patience and concentration",
                    "Maintain regular and neat handwriting",
                    "Exercise in self-control and obedience",
                    "Can be used as punishment or discipline exercise"
                ],
                strictRules: "üìè Strict Rules",
                strictRulesItems: [
                    "<strong>Support:</strong> A4 grid sheet (squares < 8mm)",
                    "<strong>Writing:</strong> CAPITAL letters only",
                    "<strong>Placement:</strong> One letter/number per cell, centered",
                    "<strong>Absolute prohibition:</strong> NEVER touch the lines",
                    "<strong>Center line:</strong> A colored vertical line can separate the sheet in two",
                    "<strong>Tolerance:</strong> ZERO mistakes accepted",
                    "<strong>Filling:</strong> The ENTIRE page must be filled (no spaces)",
                    "<strong>In case of error:</strong> Cross out and restart the entire page"
                ],
                duration: "‚è±Ô∏è Estimated Duration",
                durationItems: [
                    "About 1 hour per complete A4 sheet",
                    "Requires sustained attention without relaxation"
                ],
                attention: "‚ö†Ô∏è Points of Attention",
                attentionItems: [
                    "Check each letter before moving to the next",
                    "Maintain constant size and style",
                    "Stay calm and focused from start to finish",
                    "Accept to restart in case of error",
                    "The text repeats until the entire page is filled"
                ],
                practiceTitle: "‚úèÔ∏è Digital Practice Mode",
                practiceIntro: "Click on a cell to enlarge it and draw your letter with the mouse or finger. You must fill the ENTIRE page. The text repeats automatically until the end.",
                practiceInstructions: "<strong>Instructions:</strong> Click on the yellow cell to enlarge it. Draw your capital letter staying within the limits (red border). Validate to continue. Click on a green cell to zoom and see the letter.",
                textLabel: "Text to write:",
                textPlaceholder: "I WILL BE MORE CAREFUL",
                startButton: "Start",
                resetButton: "Reset",
                drawLetter: "Draw the letter:",
                eraseButton: "Erase",
                validateButton: "Validate",
                cancelButton: "Cancel",
                zoomTitle: "üîç Enlarged view",
                zoomCloseBtn: "Close",
                printTitle: "üñ®Ô∏è Print a blank sheet",
                printIntro: "Print this standardized grid to do the exercise by hand.",
                printNote: "<strong>Note:</strong> The red center line is optional. You can draw it with a marker after printing.",
                gridSize: "Grid size (7mm squares):",
                small: "Small (15x20)",
                medium: "Medium (20x27)",
                large: "Large (25x35)",
                generateButton: "Generate",
                printButton: "Print",
                statusReady: "Ready",
                statusNoExercise: "No exercise in progress",
                statusInProgress: "Exercise in progress - Fill the entire page",
                statusProgress: "Progress:",
                errors: "Errors:",
                cells: "cells",
                errorBorder: "‚ö†Ô∏è ERROR: Your letter touches the red borders!\n\nYou must restart the entire page.",
                completionMessage: "‚úÖ END\n\nCongratulations! The entire page is filled!",
                fillOrder: "You must fill the cells in order!",
                startFirst: "Please click \"Start\" first",
                enterText: "Please enter a text to write"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLang];
            
            document.getElementById('langButton').textContent = currentLang === 'fr' ? 'üá¨üáß EN' : 'üá´üá∑ FR';
            document.getElementById('appTitle').textContent = t.appTitle;
            
            // Update tabs
            const tabs = document.querySelectorAll('.tab');
            tabs[0].innerHTML = t.tabRules;
            tabs[1].innerHTML = t.tabPractice;
            tabs[2].innerHTML = t.tabPrint;
            
            // Update Rules tab
            const rulesTab = document.getElementById('rules');
            rulesTab.querySelector('h2').textContent = t.rulesTitle;
            rulesTab.querySelector('p').textContent = t.rulesIntro;
            
            const h3s = rulesTab.querySelectorAll('h3');
            h3s[0].textContent = t.objective;
            h3s[1].textContent = t.strictRules;
            h3s[2].textContent = t.duration;
            h3s[3].textContent = t.attention;
            
            const uls = rulesTab.querySelectorAll('ul');
            uls[0].innerHTML = t.objectiveItems.map(item => `<li>${item}</li>`).join('');
            uls[1].innerHTML = t.strictRulesItems.map(item => `<li>${item}</li>`).join('');
            uls[2].innerHTML = t.durationItems.map(item => `<li>${item}</li>`).join('');
            uls[3].innerHTML = t.attentionItems.map(item => `<li>${item}</li>`).join('');
            
            // Update Practice tab
            const practiceTab = document.getElementById('practice');
            practiceTab.querySelector('h2').textContent = t.practiceTitle;
            practiceTab.querySelectorAll('p')[0].textContent = t.practiceIntro;
            practiceTab.querySelector('label').textContent = t.textLabel + ' ';
            practiceTab.querySelector('#textInput').placeholder = t.textPlaceholder;
            practiceTab.querySelectorAll('.button')[0].textContent = t.startButton;
            practiceTab.querySelectorAll('.button')[1].textContent = t.resetButton;
            practiceTab.querySelectorAll('div')[practiceTab.querySelectorAll('div').length - 1].innerHTML = t.practiceInstructions;
            
            // Update Drawing canvas
            document.querySelector('#drawingCanvas strong').innerHTML = t.drawLetter + ' <span id="expectedLetter"></span>';
            document.querySelectorAll('#drawingCanvas .button')[0].textContent = t.eraseButton;
            document.querySelectorAll('#drawingCanvas .button')[1].textContent = t.validateButton;
            document.querySelectorAll('#drawingCanvas .button')[2].textContent = t.cancelButton;
            
            // Update Zoom viewer
            document.querySelector('.zoom-viewer-title').textContent = t.zoomTitle;
            document.querySelector('#zoomViewer .button').textContent = t.zoomCloseBtn;
            
            // Update Print tab
            const printTab = document.getElementById('print');
            printTab.querySelector('h2').textContent = t.printTitle;
            printTab.querySelectorAll('p')[0].textContent = t.printIntro;
            printTab.querySelector('label').textContent = t.gridSize + ' ';
            printTab.querySelectorAll('option')[0].textContent = t.small;
            printTab.querySelectorAll('option')[1].textContent = t.medium;
            printTab.querySelectorAll('option')[2].textContent = t.large;
            printTab.querySelectorAll('.button')[0].textContent = t.generateButton;
            printTab.querySelectorAll('.button')[1].textContent = t.printButton;
            printTab.querySelectorAll('div')[printTab.querySelectorAll('div').length - 1].innerHTML = t.printNote;
            
            // Update status bar
            document.querySelectorAll('.status-section')[0].textContent = t.statusReady;
            if (!exerciseText) {
                document.getElementById('statusText').textContent = t.statusNoExercise;
            }
            updateStatus();
        }

        function createGrid(containerId, rows, cols, interactive = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            const centerCol = Math.floor(cols / 2);
            totalCells = rows * cols;
            
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                if (i % cols === centerCol) {
                    cell.classList.add('center-line');
                }
                
                if (interactive) {
                    cell.dataset.index = i;
                    if (i === 0) {
                        cell.classList.add('next');
                    }
                    cell.addEventListener('click', () => {
                        if (cell.classList.contains('filled')) {
                            showZoomViewer(cell);
                        } else {
                            openDrawingCanvas(cell, i);
                        }
                    });
                }
                
                container.appendChild(cell);
            }
        }

        function openDrawingCanvas(cell, index) {
            const t = translations[currentLang];
            if (!exerciseText) {
                alert(t.startFirst);
                return;
            }
            
            if (index !== currentIndex) {
                alert(t.fillOrder);
                return;
            }
            
            currentCell = cell;
            
            const cleanText = exerciseText.replace(/\s+/g, '');
            const charIndex = currentIndex % cleanText.length;
            const expectedChar = cleanText[charIndex];
            
            document.getElementById('expectedLetter').textContent = expectedChar;
            document.getElementById('drawingCanvas').classList.add('active');
            
            if (!canvas) {
                canvas = document.getElementById('drawCanvas');
                ctx = canvas.getContext('2d');
                setupCanvas();
            }
            
            clearCanvas();
            drawBorders();
        }

        function setupCanvas() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            if (!touch) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            if (e.type === 'touchstart') {
                isDrawing = true;
                lastX = x;
                lastY = y;
            } else if (e.type === 'touchmove' && isDrawing) {
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            }
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function drawBorders() {
            const margin = 20;
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(margin, margin, canvas.width - 2*margin, canvas.height - 2*margin);
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawBorders();
        }

        function checkBorderTouch() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const margin = 20;
            
            // Check only near the red border (¬±1 pixel)
            for (let x = margin - 1; x <= canvas.width - margin + 1; x++) {
                for (let y = margin - 1; y <= margin + 1; y++) {
                    if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                        const index = (y * canvas.width + x) * 4;
                        if (data[index] < 180) return true;
                    }
                }
            }
            
            for (let x = margin - 1; x <= canvas.width - margin + 1; x++) {
                for (let y = canvas.height - margin - 1; y <= canvas.height - margin + 1; y++) {
                    if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                        const index = (y * canvas.width + x) * 4;
                        if (data[index] < 180) return true;
                    }
                }
            }
            
            for (let y = margin - 1; y <= canvas.height - margin + 1; y++) {
                for (let x = margin - 1; x <= margin + 1; x++) {
                    if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                        const index = (y * canvas.width + x) * 4;
                        if (data[index] < 180) return true;
                    }
                }
            }
            
            for (let y = margin - 1; y <= canvas.height - margin + 1; y++) {
                for (let x = canvas.width - margin - 1; x <= canvas.width - margin + 1; x++) {
                    if (x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
                        const index = (y * canvas.width + x) * 4;
                        if (data[index] < 180) return true;
                    }
                }
            }
            
            return false;
        }

        function validateDrawing() {
            const t = translations[currentLang];
            // ONLY check if touches red border - NO OTHER CHECKS
            const touching = checkBorderTouch();
            
            if (touching) {
                currentCell.classList.add('touching');
                errorCount++;
                alert(t.errorBorder);
                setTimeout(() => {
                    resetGrid();
                    cancelDrawing();
                }, 500);
                return;
            }
            
            // Save drawing
            const miniCanvas = document.createElement('canvas');
            miniCanvas.width = 25;
            miniCanvas.height = 25;
            const miniCtx = miniCanvas.getContext('2d');
            miniCtx.drawImage(canvas, 20, 20, 260, 260, 0, 0, 25, 25);
            
            currentCell.style.backgroundImage = `url(${miniCanvas.toDataURL()})`;
            currentCell.style.backgroundSize = 'contain';
            currentCell.style.backgroundPosition = 'center';
            currentCell.style.backgroundRepeat = 'no-repeat';
            currentCell.textContent = '';
            currentCell.dataset.drawing = canvas.toDataURL();
            currentCell.classList.remove('next');
            currentCell.classList.add('filled');
            
            currentIndex++;
            
            if (currentIndex < totalCells) {
                const nextCell = document.querySelector(`[data-index="${currentIndex}"]`);
                if (nextCell) {
                    nextCell.classList.add('next');
                }
            }
            
            updateStatus();
            cancelDrawing();
            
            if (currentIndex >= totalCells) {
                alert(t.completionMessage);
            }
        }

        function cancelDrawing() {
            document.getElementById('drawingCanvas').classList.remove('active');
        }

        function startExercise() {
            const t = translations[currentLang];
            const input = document.getElementById('textInput').value.toUpperCase().replace(/[^A-Z0-9\s]/g, '');
            if (!input.trim()) {
                alert(t.enterText);
                return;
            }
            exerciseText = input;
            currentIndex = 0;
            errorCount = 0;
            updateStatus();
            createGrid('practiceGrid', GRID_ROWS, GRID_COLS, true);
            document.getElementById('statusText').textContent = t.statusInProgress;
        }

        function resetGrid() {
            createGrid('practiceGrid', GRID_ROWS, GRID_COLS, true);
            currentIndex = 0;
            errorCount = 0;
            currentCell = null;
            updateStatus();
        }

        function updateStatus() {
            const t = translations[currentLang];
            document.getElementById('errorCount').textContent = `${t.errors} ${errorCount}`;
            if (exerciseText) {
                const progress = Math.min(100, Math.floor((currentIndex / totalCells) * 100));
                document.getElementById('statusText').textContent = `${t.statusProgress} ${progress}% (${currentIndex}/${totalCells} ${t.cells})`;
            }
        }

        function showZoomViewer(cell) {
            const drawingData = cell.dataset.drawing;
            if (!drawingData) return;
            
            const zoomCanvas = document.getElementById('zoomCanvas');
            const zoomCtx = zoomCanvas.getContext('2d');
            
            const img = new Image();
            img.onload = function() {
                zoomCtx.fillStyle = 'white';
                zoomCtx.fillRect(0, 0, zoomCanvas.width, zoomCanvas.height);
                zoomCtx.drawImage(img, 0, 0, zoomCanvas.width, zoomCanvas.height);
                
                const margin = 27;
                zoomCtx.strokeStyle = '#ff0000';
                zoomCtx.lineWidth = 3;
                zoomCtx.strokeRect(margin, margin, zoomCanvas.width - 2*margin, zoomCanvas.height - 2*margin);
            };
            img.src = drawingData;
            
            document.getElementById('zoomOverlay').classList.add('active');
            document.getElementById('zoomViewer').classList.add('active');
        }

        function closeZoomViewer() {
            document.getElementById('zoomOverlay').classList.remove('active');
            document.getElementById('zoomViewer').classList.remove('active');
        }

        function generatePrintGrid() {
            const size = document.getElementById('gridSize').value;
            let rows, cols;
            
            switch(size) {
                case 'small': rows = 15; cols = 20; break;
                case 'large': rows = 25; cols = 35; break;
                default: rows = 20; cols = 27;
            }
            
            createGrid('printGrid', rows, cols, false);
        }

        // Initialize
        createGrid('practiceGrid', GRID_ROWS, GRID_COLS, true);
        generatePrintGrid();
    </script>
</body>
</html>
