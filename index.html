<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squares - Exercice de Discipline</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'MS Sans Serif', Arial, sans-serif;
            background: #008080;
            padding: 20px;
            color: #000;
        }

        .window {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            max-width: 900px;
            margin: 0 auto;
        }

        .title-bar {
            background: linear-gradient(to right, #000080, #1084d0);
            color: white;
            padding: 3px 5px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-text {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lang-button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 10px;
        }

        .lang-button:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        .content {
            padding: 20px;
            background: #c0c0c0;
        }

        .tab-container {
            margin-bottom: 15px;
        }

        .tabs {
            display: flex;
            gap: 2px;
            margin-bottom: -2px;
        }

        .tab {
            padding: 5px 15px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 transparent #ffffff;
            cursor: pointer;
            position: relative;
            top: 2px;
        }

        .tab.active {
            background: #c0c0c0;
            border-bottom-color: #c0c0c0;
            z-index: 1;
        }

        .tab-content {
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 15px;
            background: #c0c0c0;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            padding: 8px 20px;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial;
            font-size: 11px;
            margin: 5px;
        }

        .button:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        .button:disabled {
            color: #808080;
            cursor: default;
        }

        h2 {
            font-size: 14px;
            margin-bottom: 10px;
            padding: 3px;
            background: #000080;
            color: white;
        }

        h3 {
            font-size: 12px;
            margin: 10px 0 5px 0;
        }

        ul {
            margin-left: 20px;
            font-size: 11px;
            line-height: 1.6;
        }

        .grid-container {
            display: inline-block;
            background: white;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 10px;
            margin: 10px 0;
            max-width: 100%;
            overflow-x: auto;
        }

        .grid {
            display: grid;
            gap: 0;
            background: white;
            border: 1px solid #000;
        }

        .cell {
            width: 25px;
            height: 25px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .cell.next {
            background: #ffffcc;
        }

        .cell.filled {
            background: #e0ffe0;
        }

        .drawing-canvas {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 4px solid #000080;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 10px;
        }

        .drawing-canvas.active {
            display: block;
        }

        .completion-dialog {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #c0c0c0;
            border: 3px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            box-shadow: 0 0 30px rgba(0,0,0,0.7);
            z-index: 2000;
            padding: 20px;
            min-width: 400px;
            max-width: 90%;
        }

        .completion-dialog.active {
            display: block;
        }

        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
        }

        .dialog-overlay.active {
            display: block;
        }

        .dialog-title {
            background: linear-gradient(to right, #000080, #1084d0);
            color: white;
            padding: 5px 10px;
            margin: -20px -20px 15px -20px;
            font-weight: bold;
            font-size: 14px;
        }

        .dialog-content {
            text-align: center;
        }

        .completion-icon {
            font-size: 48px;
            margin: 10px 0;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .share-button {
            background: #c0c0c0;
            border: 2px solid;
            border-color: #ffffff #000000 #000000 #ffffff;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'MS Sans Serif', Arial;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .share-button:active {
            border-color: #000000 #ffffff #ffffff #000000;
        }

        .canvas-wrapper {
            background: white;
            border: 2px solid #000;
        }

        canvas {
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .canvas-controls {
            margin-top: 10px;
            text-align: center;
        }

        .cell.center-line {
            border-right: 2px solid #ff0000;
        }

        .cell.error {
            background: #ffcccc;
        }

        .cell.touching {
            background: #ffeeee;
        }

        .controls {
            margin: 15px 0;
            padding: 10px;
            background: #c0c0c0;
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
        }

        .status-bar {
            background: #c0c0c0;
            border-top: 2px solid;
            border-color: #ffffff #808080 #808080 #ffffff;
            padding: 3px 5px;
            font-size: 11px;
            display: flex;
            gap: 10px;
        }

        .status-section {
            border: 1px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 2px 5px;
        }

        input[type="text"] {
            border: 2px solid;
            border-color: #808080 #ffffff #ffffff #808080;
            padding: 3px;
            font-family: 'MS Sans Serif', Arial;
        }

        input[type="text"]::placeholder {
            color: #808080;
            font-style: italic;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .window {
                border: none;
                box-shadow: none;
            }
            .title-bar, .tabs, .controls, .status-bar, .button {
                display: none !important;
            }
            .tab-content {
                border: none;
                padding: 0;
            }
            .grid {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="window">
        <div class="title-bar">
            <div class="title-text">
                <span>üìã</span>
                <span id="appTitle">Squares - Exercice de Discipline</span>
            </div>
            <button class="lang-button" onclick="toggleLanguage()">
                <span id="langButton">üá¨üáß EN</span>
            </button>
        </div>

        <div class="content">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('rules')">üìñ R√®gles</div>
                    <div class="tab" onclick="switchTab('practice')">‚úèÔ∏è Pratiquer</div>
                    <div class="tab" onclick="switchTab('print')">üñ®Ô∏è Imprimer</div>
                </div>

                <div id="rules" class="tab-content active">
                    <h2>üìã Principe de l'exercice "Squares"</h2>
                    <p style="font-size: 11px; margin: 10px 0;">
                        Le "Square" est un exercice de concentration, patience et discipline consistant √† remplir une feuille quadrill√©e avec une lettre ou un chiffre par case, sans jamais toucher les lignes.
                    </p>

                    <h3>üéØ Objectif</h3>
                    <ul>
                        <li>D√©velopper la patience et la concentration</li>
                        <li>Maintenir une √©criture r√©guli√®re et soign√©e</li>
                        <li>Exercice de contr√¥le de soi et d'ob√©issance</li>
                        <li>Peut √™tre utilis√© comme punition ou exercice de discipline</li>
                    </ul>

                    <h3>üìè R√®gles strictes</h3>
                    <ul>
                        <li><strong>Support :</strong> Feuille A4 quadrill√©e (carr√©s < 8mm)</li>
                        <li><strong>√âcriture :</strong> Lettres CAPITALES uniquement</li>
                        <li><strong>Placement :</strong> Une lettre/chiffre par case, centr√©e</li>
                        <li><strong>Interdiction absolue :</strong> Ne JAMAIS toucher les lignes</li>
                        <li><strong>Ligne centrale :</strong> Une ligne verticale color√©e peut s√©parer la feuille en deux</li>
                        <li><strong>Tol√©rance :</strong> Z√âRO faute accept√©e</li>
                        <li><strong>Remplissage :</strong> TOUTE la page doit √™tre remplie (pas d'espaces)</li>
                        <li><strong>En cas d'erreur :</strong> Barrer et recommencer la page enti√®re</li>
                    </ul>

                    <h3>‚è±Ô∏è Dur√©e estim√©e</h3>
                    <ul>
                        <li>Environ 1 heure par feuille A4 compl√®te</li>
                        <li>N√©cessite une attention soutenue sans rel√¢chement</li>
                    </ul>

                    <h3>‚ö†Ô∏è Points d'attention</h3>
                    <ul>
                        <li>V√©rifier chaque lettre avant de passer √† la suivante</li>
                        <li>Maintenir une taille et un style constants</li>
                        <li>Rester calme et concentr√© du d√©but √† la fin</li>
                        <li>Accepter de recommencer en cas d'erreur</li>
                        <li>Le texte se r√©p√®te jusqu'√† remplir toute la page</li>
                    </ul>
                </div>

                <div id="practice" class="tab-content">
                    <h2>‚úèÔ∏è Mode Pratique (Digital)</h2>
                    <p style="font-size: 11px; margin: 10px 0;">
                        Cliquez sur une case pour l'agrandir et dessinez votre lettre avec la souris ou le doigt. Vous devez remplir TOUTE la page. Le texte se r√©p√®te automatiquement jusqu'√† la fin.
                    </p>

                    <div class="controls">
                        <label>Texte √† √©crire: </label>
                        <input type="text" id="textInput" placeholder="JE SERAI PLUS ATTENTIF" value="" style="width: 300px;">
                        <button class="button" onclick="startExercise()">Commencer</button>
                        <button class="button" onclick="resetGrid()">R√©initialiser</button>
                    </div>

                    <div class="grid-container">
                        <div id="practiceGrid" class="grid"></div>
                    </div>

                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Instructions:</strong> Cliquez sur la case jaune pour l'agrandir. Dessinez votre lettre capitale en restant dans les limites (bordure rouge). Validez ou effacez si besoin. Le texte se r√©p√®te automatiquement jusqu'√† ce que toute la page soit remplie.
                    </div>
                </div>

                <div class="drawing-canvas" id="drawingCanvas">
                    <div style="background: #000080; color: white; padding: 5px; margin-bottom: 10px;">
                        <strong>Dessinez la lettre: <span id="expectedLetter"></span></strong>
                    </div>
                    <div class="canvas-wrapper">
                        <canvas id="drawCanvas" width="300" height="300"></canvas>
                    </div>
                    <div class="canvas-controls">
                        <button class="button" onclick="clearCanvas()">Effacer</button>
                        <button class="button" onclick="validateDrawing()">Valider</button>
                        <button class="button" onclick="cancelDrawing()">Annuler</button>
                    </div>
                </div>

                <div class="dialog-overlay" id="dialogOverlay"></div>
                <div class="completion-dialog" id="completionDialog">
                    <div class="dialog-title">‚úÖ Exercice Termin√© !</div>
                    <div class="dialog-content">
                        <div class="completion-icon">üèÜ</div>
                        <h3 style="margin: 10px 0;">F√©licitations !</h3>
                        <p style="font-size: 12px; margin: 10px 0;">
                            Vous avez compl√©t√© l'exercice "Squares" avec succ√®s !
                        </p>
                        <div style="background: #fff; border: 2px solid #000; padding: 10px; margin: 15px 0; text-align: left;">
                            <strong>R√©sultats :</strong><br>
                            ‚Ä¢ Temps: <span id="completionTime">-</span><br>
                            ‚Ä¢ Erreurs: <span id="completionErrors">0</span><br>
                            ‚Ä¢ Cases remplies: 540
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <button class="button" onclick="downloadCertificate()" style="display: block; width: 90%; margin: 5px auto;">
                                üíæ T√©l√©charger le certificat
                            </button>
                        </div>
                        
                        <div style="border-top: 2px solid #808080; padding-top: 15px; margin-top: 15px;">
                            <strong style="font-size: 11px;">Partager sur les r√©seaux sociaux:</strong>
                            <div class="share-buttons">
                                <button class="share-button" onclick="shareCertificate('Twitter')">
                                    üê¶ Twitter
                                </button>
                                <button class="share-button" onclick="shareCertificate('Facebook')">
                                    üìò Facebook
                                </button>
                                <button class="share-button" onclick="shareCertificate('Instagram')">
                                    üì∑ Instagram
                                </button>
                                <button class="share-button" onclick="shareCertificate('WhatsApp')">
                                    üí¨ WhatsApp
                                </button>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="button" onclick="closeCompletionDialog()">
                                Fermer
                            </button>
                        </div>
                    </div>
                </div>

                <div id="print" class="tab-content">
                    <h2>üñ®Ô∏è Imprimer une feuille vierge</h2>
                    <p style="font-size: 11px; margin: 10px 0;">
                        Imprimez cette grille normalis√©e pour r√©aliser l'exercice √† la main.
                    </p>

                    <div class="controls">
                        <label>Taille de la grille (carr√©s de 7mm): </label>
                        <select id="gridSize">
                            <option value="small">Petite (15x20)</option>
                            <option value="medium" selected>Moyenne (20x27)</option>
                            <option value="large">Grande (25x35)</option>
                        </select>
                        <button class="button" onclick="generatePrintGrid()">G√©n√©rer</button>
                        <button class="button" onclick="window.print()">Imprimer</button>
                    </div>

                    <div class="grid-container">
                        <div id="printGrid" class="grid"></div>
                    </div>

                    <div style="margin-top: 10px; font-size: 11px;">
                        <strong>Note:</strong> La ligne rouge centrale est optionnelle. Vous pouvez la tracer au marqueur apr√®s impression.
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-section">Pr√™t</div>
            <div class="status-section" id="statusText">Aucun exercice en cours</div>
            <div class="status-section" id="errorCount">Erreurs: 0</div>
        </div>
    </div>

    <script>
        let currentCell = null;
        let exerciseText = '';
        let currentIndex = 0;
        let errorCount = 0;
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let totalCells = 0;
        const GRID_ROWS = 20;
        const GRID_COLS = 27;
        let currentLang = 'fr';

        const translations = {
            fr: {
                appTitle: "Squares - Exercice de Discipline",
                tabRules: "üìñ R√®gles",
                tabPractice: "‚úèÔ∏è Pratiquer",
                tabPrint: "üñ®Ô∏è Imprimer",
                rulesTitle: "üìã Principe de l'exercice \"Squares\"",
                rulesIntro: "Le \"Square\" est un exercice de concentration, patience et discipline consistant √† remplir une feuille quadrill√©e avec une lettre ou un chiffre par case, sans jamais toucher les lignes.",
                objective: "üéØ Objectif",
                objectiveList: [
                    "D√©velopper la patience et la concentration",
                    "Maintenir une √©criture r√©guli√®re et soign√©e",
                    "Exercice de contr√¥le de soi et d'ob√©issance",
                    "Peut √™tre utilis√© comme punition ou exercice de discipline"
                ],
                strictRules: "üìè R√®gles strictes",
                rulesList: [
                    "<strong>Support :</strong> Feuille A4 quadrill√©e (carr√©s < 8mm)",
                    "<strong>√âcriture :</strong> Lettres CAPITALES uniquement",
                    "<strong>Placement :</strong> Une lettre/chiffre par case, centr√©e",
                    "<strong>Interdiction absolue :</strong> Ne JAMAIS toucher les lignes",
                    "<strong>Ligne centrale :</strong> Une ligne verticale color√©e peut s√©parer la feuille en deux",
                    "<strong>Tol√©rance :</strong> Z√âRO faute accept√©e",
                    "<strong>Remplissage :</strong> TOUTE la page doit √™tre remplie (pas d'espaces)",
                    "<strong>En cas d'erreur :</strong> Barrer et recommencer la page enti√®re"
                ],
                duration: "‚è±Ô∏è Dur√©e estim√©e",
                durationList: [
                    "Environ 1 heure par feuille A4 compl√®te",
                    "N√©cessite une attention soutenue sans rel√¢chement"
                ],
                attention: "‚ö†Ô∏è Points d'attention",
                attentionList: [
                    "V√©rifier chaque lettre avant de passer √† la suivante",
                    "Maintenir une taille et un style constants",
                    "Rester calme et concentr√© du d√©but √† la fin",
                    "Accepter de recommencer en cas d'erreur",
                    "Le texte se r√©p√®te jusqu'√† remplir toute la page"
                ],
                practiceTitle: "‚úèÔ∏è Mode Pratique (Digital)",
                practiceIntro: "Cliquez sur une case pour l'agrandir et dessinez votre lettre avec la souris ou le doigt. Vous devez remplir TOUTE la page. Le texte se r√©p√®te automatiquement jusqu'√† la fin.",
                practiceInstructions: "<strong>Instructions:</strong> Cliquez sur la case jaune pour l'agrandir. Dessinez votre lettre capitale en restant dans les limites (bordure rouge). Validez ou effacez si besoin. Le texte se r√©p√®te automatiquement jusqu'√† ce que toute la page soit remplie.",
                textLabel: "Texte √† √©crire:",
                textPlaceholder: "JE SERAI PLUS ATTENTIF",
                startButton: "Commencer",
                resetButton: "R√©initialiser",
                drawLetter: "Dessinez la lettre:",
                eraseButton: "Effacer",
                validateButton: "Valider",
                cancelButton: "Annuler",
                printTitle: "üñ®Ô∏è Imprimer une feuille vierge",
                printIntro: "Imprimez cette grille normalis√©e pour r√©aliser l'exercice √† la main.",
                printNote: "<strong>Note:</strong> La ligne rouge centrale est optionnelle. Vous pouvez la tracer au marqueur apr√®s impression.",
                gridSize: "Taille de la grille (carr√©s de 7mm):",
                small: "Petite (15x20)",
                medium: "Moyenne (20x27)",
                large: "Grande (25x35)",
                generateButton: "G√©n√©rer",
                printButton: "Imprimer",
                statusReady: "Pr√™t",
                statusNoExercise: "Aucun exercice en cours",
                statusInProgress: "Exercice en cours - Remplissez toute la page",
                statusProgress: "Progression:",
                errors: "Erreurs:",
                cells: "cases",
                errorBorder: "‚ö†Ô∏è ERREUR: Votre lettre touche les bords!\n\nVous devez recommencer la page enti√®re.",
                errorWrongLetter: "‚ö†Ô∏è ERREUR: Ce n'est pas la lettre",
                errorMustRestart: "Vous devez recommencer la page enti√®re.",
                completionTitle: "‚úÖ Exercice Termin√© !",
                congratulations: "F√©licitations !",
                completionMessage: "Vous avez compl√©t√© l'exercice \"Squares\" avec succ√®s !",
                results: "R√©sultats :",
                time: "Temps:",
                cellsFilled: "Cases remplies:",
                minutes: "minutes",
                lessThanMinute: "Moins d'une minute",
                downloadCert: "üíæ T√©l√©charger le certificat",
                shareOn: "Partager sur les r√©seaux sociaux:",
                closeButton: "Fermer",
                fillOrder: "Vous devez remplir les cases dans l'ordre !",
                startFirst: "Veuillez d'abord cliquer sur \"Commencer\"",
                enterText: "Veuillez entrer un texte √† √©crire"
            },
            en: {
                appTitle: "Squares - Discipline Exercise",
                tabRules: "üìñ Rules",
                tabPractice: "‚úèÔ∏è Practice",
                tabPrint: "üñ®Ô∏è Print",
                rulesTitle: "üìã \"Squares\" Exercise Principle",
                rulesIntro: "The \"Square\" is a concentration, patience and discipline exercise consisting of filling a grid sheet with one letter or number per cell, without ever touching the lines.",
                objective: "üéØ Objective",
                objectiveList: [
                    "Develop patience and concentration",
                    "Maintain regular and neat handwriting",
                    "Exercise in self-control and obedience",
                    "Can be used as punishment or discipline exercise"
                ],
                strictRules: "üìè Strict Rules",
                rulesList: [
                    "<strong>Support:</strong> A4 grid sheet (squares < 8mm)",
                    "<strong>Writing:</strong> CAPITAL letters only",
                    "<strong>Placement:</strong> One letter/number per cell, centered",
                    "<strong>Absolute prohibition:</strong> NEVER touch the lines",
                    "<strong>Center line:</strong> A colored vertical line can separate the sheet in two",
                    "<strong>Tolerance:</strong> ZERO mistakes accepted",
                    "<strong>Filling:</strong> The ENTIRE page must be filled (no spaces)",
                    "<strong>In case of error:</strong> Cross out and restart the entire page"
                ],
                duration: "‚è±Ô∏è Estimated Duration",
                durationList: [
                    "About 1 hour per complete A4 sheet",
                    "Requires sustained attention without relaxation"
                ],
                attention: "‚ö†Ô∏è Points of Attention",
                attentionList: [
                    "Check each letter before moving to the next",
                    "Maintain constant size and style",
                    "Stay calm and focused from start to finish",
                    "Accept to restart in case of error",
                    "The text repeats until the entire page is filled"
                ],
                practiceTitle: "‚úèÔ∏è Digital Practice Mode",
                practiceIntro: "Click on a cell to enlarge it and draw your letter with the mouse or finger. You must fill the ENTIRE page. The text repeats automatically until the end.",
                practiceInstructions: "<strong>Instructions:</strong> Click on the yellow cell to enlarge it. Draw your capital letter staying within the limits (red border). Validate or erase if needed. The text repeats automatically until the entire page is filled.",
                textLabel: "Text to write:",
                textPlaceholder: "I WILL BE MORE CAREFUL",
                startButton: "Start",
                resetButton: "Reset",
                drawLetter: "Draw the letter:",
                eraseButton: "Erase",
                validateButton: "Validate",
                cancelButton: "Cancel",
                printTitle: "üñ®Ô∏è Print a blank sheet",
                printIntro: "Print this standardized grid to do the exercise by hand.",
                printNote: "<strong>Note:</strong> The red center line is optional. You can draw it with a marker after printing.",
                gridSize: "Grid size (7mm squares):",
                small: "Small (15x20)",
                medium: "Medium (20x27)",
                large: "Large (25x35)",
                generateButton: "Generate",
                printButton: "Print",
                statusReady: "Ready",
                statusNoExercise: "No exercise in progress",
                statusInProgress: "Exercise in progress - Fill the entire page",
                statusProgress: "Progress:",
                errors: "Errors:",
                cells: "cells",
                errorBorder: "‚ö†Ô∏è ERROR: Your letter touches the borders!\n\nYou must restart the entire page.",
                errorWrongLetter: "‚ö†Ô∏è ERROR: This is not the letter",
                errorMustRestart: "You must restart the entire page.",
                completionTitle: "‚úÖ Exercise Completed!",
                congratulations: "Congratulations!",
                completionMessage: "You have successfully completed the \"Squares\" exercise!",
                results: "Results:",
                time: "Time:",
                cellsFilled: "Cells filled:",
                minutes: "minutes",
                lessThanMinute: "Less than a minute",
                downloadCert: "üíæ Download certificate",
                shareOn: "Share on social media:",
                closeButton: "Close",
                fillOrder: "You must fill the cells in order!",
                startFirst: "Please click \"Start\" first",
                enterText: "Please enter a text to write"
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            updateLanguage();
        }

        function updateLanguage() {
            const t = translations[currentLang];
            
            document.getElementById('appTitle').textContent = t.appTitle;
            document.getElementById('langButton').textContent = currentLang === 'fr' ? 'üá¨üáß EN' : 'üá´üá∑ FR';
            
            // Tabs
            const tabs = document.querySelectorAll('.tab');
            if (tabs[0]) tabs[0].innerHTML = t.tabRules;
            if (tabs[1]) tabs[1].innerHTML = t.tabPractice;
            if (tabs[2]) tabs[2].innerHTML = t.tabPrint;
            
            // Rules tab
            const rulesContent = document.getElementById('rules');
            if (rulesContent) {
                const rulesH2 = rulesContent.querySelector('h2');
                const rulesP = rulesContent.querySelector('p');
                if (rulesH2) rulesH2.textContent = t.rulesTitle;
                if (rulesP) rulesP.textContent = t.rulesIntro;
                
                const h3s = rulesContent.querySelectorAll('h3');
                if (h3s[0]) h3s[0].textContent = t.objective;
                if (h3s[1]) h3s[1].textContent = t.strictRules;
                if (h3s[2]) h3s[2].textContent = t.duration;
                if (h3s[3]) h3s[3].textContent = t.attention;
                
                const uls = rulesContent.querySelectorAll('ul');
                if (uls[0]) uls[0].innerHTML = t.objectiveList.map(item => `<li>${item}</li>`).join('');
                if (uls[1]) uls[1].innerHTML = t.rulesList.map(item => `<li>${item}</li>`).join('');
                if (uls[2]) uls[2].innerHTML = t.durationList.map(item => `<li>${item}</li>`).join('');
                if (uls[3]) uls[3].innerHTML = t.attentionList.map(item => `<li>${item}</li>`).join('');
            }
            
            // Practice tab
            const practiceContent = document.getElementById('practice');
            if (practiceContent) {
                const practiceH2 = practiceContent.querySelector('h2');
                const practicePs = practiceContent.querySelectorAll('p');
                const practiceLabels = practiceContent.querySelectorAll('label');
                const practiceButtons = practiceContent.querySelectorAll('button');
                const practiceDivs = practiceContent.querySelectorAll('div');
                const practiceInput = practiceContent.querySelector('#textInput');
                
                if (practiceH2) practiceH2.textContent = t.practiceTitle;
                if (practicePs[0]) practicePs[0].textContent = t.practiceIntro;
                if (practiceLabels[0]) practiceLabels[0].textContent = t.textLabel + ' ';
                if (practiceInput) practiceInput.placeholder = t.textPlaceholder;
                if (practiceButtons[0]) practiceButtons[0].textContent = t.startButton;
                if (practiceButtons[1]) practiceButtons[1].textContent = t.resetButton;
                if (practiceDivs[2]) practiceDivs[2].innerHTML = t.practiceInstructions;
            }
            
            // Drawing canvas
            const drawingStrong = document.querySelector('#drawingCanvas strong');
            if (drawingStrong) {
                drawingStrong.innerHTML = t.drawLetter + ' <span id="expectedLetter"></span>';
            }
            const drawingButtons = document.querySelectorAll('#drawingCanvas .button');
            if (drawingButtons[0]) drawingButtons[0].textContent = t.eraseButton;
            if (drawingButtons[1]) drawingButtons[1].textContent = t.validateButton;
            if (drawingButtons[2]) drawingButtons[2].textContent = t.cancelButton;
            
            // Print tab
            const printContent = document.getElementById('print');
            if (printContent) {
                const printH2 = printContent.querySelector('h2');
                const printPs = printContent.querySelectorAll('p');
                const printLabels = printContent.querySelectorAll('label');
                const printButtons = printContent.querySelectorAll('button');
                const printDivs = printContent.querySelectorAll('div');
                
                if (printH2) printH2.textContent = t.printTitle;
                if (printPs[0]) printPs[0].textContent = t.printIntro;
                if (printLabels[0]) printLabels[0].textContent = t.gridSize + ' ';
                
                const selectOptions = printContent.querySelectorAll('option');
                if (selectOptions[0]) selectOptions[0].textContent = t.small;
                if (selectOptions[1]) selectOptions[1].textContent = t.medium;
                if (selectOptions[2]) selectOptions[2].textContent = t.large;
                
                if (printButtons[0]) printButtons[0].textContent = t.generateButton;
                if (printButtons[1]) printButtons[1].textContent = t.printButton;
                if (printDivs[2]) printDivs[2].innerHTML = t.printNote;
            }
            
            // Status bar
            const statusSections = document.querySelectorAll('.status-section');
            if (statusSections[0]) statusSections[0].textContent = t.statusReady;
            const statusText = document.getElementById('statusText');
            if (statusText && !exerciseText) {
                statusText.textContent = t.statusNoExercise;
            }
            updateStatus();
            
            // Completion dialog elements
            const dialogTitle = document.querySelector('.dialog-title');
            if (dialogTitle) dialogTitle.textContent = t.completionTitle;
            
            const dialogH3 = document.querySelector('.completion-dialog h3');
            if (dialogH3) dialogH3.textContent = t.congratulations;
            
            const dialogPs = document.querySelectorAll('.completion-dialog p');
            if (dialogPs[0]) dialogPs[0].textContent = t.completionMessage;
            
            const dialogButtons = document.querySelectorAll('.completion-dialog .button');
            if (dialogButtons[0]) dialogButtons[0].textContent = t.downloadCert;
            
            const shareStrongs = document.querySelectorAll('.completion-dialog strong');
            if (shareStrongs[1]) shareStrongs[1].textContent = t.shareOn;
            
            // Find close button more reliably
            const allDialogButtons = document.querySelectorAll('.completion-dialog .button');
            allDialogButtons.forEach(btn => {
                if (btn.getAttribute('onclick') === 'closeCompletionDialog()') {
                    btn.textContent = t.closeButton;
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function createGrid(containerId, rows, cols, interactive = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            const centerCol = Math.floor(cols / 2);
            totalCells = rows * cols;
            
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                
                if (i % cols === centerCol) {
                    cell.classList.add('center-line');
                }
                
                if (interactive) {
                    cell.dataset.index = i;
                    if (i === 0) {
                        cell.classList.add('next');
                    }
                    cell.addEventListener('click', () => openDrawingCanvas(cell, i));
                }
                
                container.appendChild(cell);
            }
        }

        function openDrawingCanvas(cell, index) {
            if (!exerciseText) {
                alert('Veuillez d\'abord cliquer sur "Commencer"');
                return;
            }
            
            if (index !== currentIndex) {
                alert('Vous devez remplir les cases dans l\'ordre !');
                return;
            }
            
            currentCell = cell;
            
            // Remove spaces from text for continuous filling
            const cleanText = exerciseText.replace(/\s+/g, '');
            const charIndex = currentIndex % cleanText.length;
            const expectedChar = cleanText[charIndex];
            
            document.getElementById('expectedLetter').textContent = expectedChar;
            document.getElementById('drawingCanvas').classList.add('active');
            
            if (!canvas) {
                canvas = document.getElementById('drawCanvas');
                ctx = canvas.getContext('2d');
                setupCanvas();
            }
            
            clearCanvas();
            drawBorders();
        }

        function setupCanvas() {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            lastX = x;
            lastY = y;
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            if (e.type === 'touchstart') {
                isDrawing = true;
                lastX = x;
                lastY = y;
            } else if (e.type === 'touchmove' && isDrawing) {
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                lastX = x;
                lastY = y;
            }
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function drawBorders() {
            const margin = 20;
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.strokeRect(margin, margin, canvas.width - 2*margin, canvas.height - 2*margin);
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            drawBorders();
        }

        function checkBorderTouch() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const margin = 20;
            
            for (let x = margin; x < canvas.width - margin; x++) {
                for (let y = margin - 5; y < margin + 5; y++) {
                    const index = (y * canvas.width + x) * 4;
                    if (data[index] < 200) return true;
                }
                for (let y = canvas.height - margin - 5; y < canvas.height - margin + 5; y++) {
                    const index = (y * canvas.width + x) * 4;
                    if (data[index] < 200) return true;
                }
            }
            
            for (let y = margin; y < canvas.height - margin; y++) {
                for (let x = margin - 5; x < margin + 5; x++) {
                    const index = (y * canvas.width + x) * 4;
                    if (data[index] < 200) return true;
                }
                for (let x = canvas.width - margin - 5; x < canvas.width - margin + 5; x++) {
                    const index = (y * canvas.width + x) * 4;
                    if (data[index] < 200) return true;
                }
            }
            
            return false;
        }

        function validateDrawing() {
            const touching = checkBorderTouch();
            
            if (touching) {
                currentCell.classList.add('touching');
                errorCount++;
                alert('‚ö†Ô∏è ERREUR: Votre lettre touche les bords!\n\nVous devez recommencer la page enti√®re.');
                setTimeout(() => {
                    resetGrid();
                    cancelDrawing();
                }, 500);
                return;
            }
            
            // Character recognition
            const cleanText = exerciseText.replace(/\s+/g, '');
            const charIndex = currentIndex % cleanText.length;
            const expectedChar = cleanText[charIndex];
            
            const isCorrectChar = recognizeCharacter(expectedChar);
            
            if (!isCorrectChar) {
                currentCell.classList.add('error');
                errorCount++;
                alert(`‚ö†Ô∏è ERREUR: Ce n'est pas la lettre "${expectedChar}"!\n\nVous devez recommencer la page enti√®re.`);
                setTimeout(() => {
                    resetGrid();
                    cancelDrawing();
                }, 500);
                return;
            }
            
            const miniCanvas = document.createElement('canvas');
            miniCanvas.width = 25;
            miniCanvas.height = 25;
            const miniCtx = miniCanvas.getContext('2d');
            miniCtx.drawImage(canvas, 20, 20, 260, 260, 0, 0, 25, 25);
            
            currentCell.style.backgroundImage = `url(${miniCanvas.toDataURL()})`;
            currentCell.style.backgroundSize = 'contain';
            currentCell.style.backgroundPosition = 'center';
            currentCell.style.backgroundRepeat = 'no-repeat';
            currentCell.textContent = '';
            currentCell.classList.remove('next');
            currentCell.classList.add('filled');
            
            currentIndex++;
            
            // Highlight next cell
            if (currentIndex < totalCells) {
                const nextCell = document.querySelector(`[data-index="${currentIndex}"]`);
                if (nextCell) {
                    nextCell.classList.add('next');
                }
            }
            
            updateStatus();
            cancelDrawing();
            
            if (currentIndex >= totalCells) {
                showCompletionDialog();
            }
        }

        function showCompletionDialog() {
            const t = translations[currentLang];
            const dialog = document.getElementById('completionDialog');
            dialog.classList.add('active');
            
            // Update completion info
            const endTime = new Date();
            const startTimeStored = window.exerciseStartTime || endTime;
            const duration = Math.floor((endTime - startTimeStored) / 60000);
            
            const timeText = duration > 0 ? `${duration} ${t.minutes}` : t.lessThanMinute;
            document.getElementById('completionTime').textContent = timeText;
            document.getElementById('completionErrors').textContent = errorCount;
            
            // Update dialog text
            document.querySelector('.dialog-title').textContent = t.completionTitle;
            document.querySelector('.completion-dialog h3').textContent = t.congratulations;
            document.querySelectorAll('.completion-dialog p')[0].textContent = t.completionMessage;
            
            const resultDiv = document.querySelector('.completion-dialog > div > div:nth-child(4)');
            resultDiv.innerHTML = `<strong>${t.results}</strong><br>‚Ä¢ ${t.time} <span id="completionTime">${timeText}</span><br>‚Ä¢ ${t.errors} <span id="completionErrors">${errorCount}</span><br>‚Ä¢ ${t.cellsFilled} 540`;
        }

        function closeCompletionDialog() {
            document.getElementById('completionDialog').classList.remove('active');
        }

        function generateCertificate() {
            const certCanvas = document.createElement('canvas');
            certCanvas.width = 800;
            certCanvas.height = 600;
            const certCtx = certCanvas.getContext('2d');
            
            // Background
            certCtx.fillStyle = '#f5f5dc';
            certCtx.fillRect(0, 0, 800, 600);
            
            // Border
            certCtx.strokeStyle = '#8b4513';
            certCtx.lineWidth = 8;
            certCtx.strokeRect(20, 20, 760, 560);
            
            certCtx.strokeStyle = '#d2691e';
            certCtx.lineWidth = 2;
            certCtx.strokeRect(30, 30, 740, 540);
            
            // Title
            certCtx.fillStyle = '#000080';
            certCtx.font = 'bold 48px serif';
            certCtx.textAlign = 'center';
            certCtx.fillText('CERTIFICAT D\'ACCOMPLISSEMENT', 400, 100);
            
            // Subtitle
            certCtx.font = 'italic 24px serif';
            certCtx.fillStyle = '#333';
            certCtx.fillText('Exercice de Discipline "Squares"', 400, 150);
            
            // Main text
            certCtx.font = '20px serif';
            certCtx.fillStyle = '#000';
            certCtx.fillText('Certifie que l\'exercice a √©t√© compl√©t√©', 400, 220);
            certCtx.fillText('avec succ√®s le ' + new Date().toLocaleDateString('fr-FR'), 400, 260);
            
            // Stats box
            certCtx.fillStyle = '#fff';
            certCtx.fillRect(200, 300, 400, 120);
            certCtx.strokeStyle = '#000080';
            certCtx.lineWidth = 2;
            certCtx.strokeRect(200, 300, 400, 120);
            
            certCtx.fillStyle = '#000';
            certCtx.font = 'bold 18px sans-serif';
            certCtx.textAlign = 'left';
            certCtx.fillText('Statistiques:', 220, 330);
            
            certCtx.font = '16px sans-serif';
            const endTime = new Date();
            const startTimeStored = window.exerciseStartTime || endTime;
            const duration = Math.floor((endTime - startTimeStored) / 60000);
            
            certCtx.fillText(`‚Ä¢ Temps: ${duration > 0 ? duration + ' minutes' : 'Moins d\'une minute'}`, 220, 360);
            certCtx.fillText(`‚Ä¢ Erreurs: ${errorCount}`, 220, 385);
            certCtx.fillText(`‚Ä¢ Cases remplies: ${totalCells}`, 220, 410);
            
            // Mini grid preview (with watermark)
            const scale = 0.8;
            const gridPreviewX = 250;
            const gridPreviewY = 440;
            
            certCtx.save();
            certCtx.translate(gridPreviewX, gridPreviewY);
            certCtx.scale(scale, scale);
            
            const practiceGrid = document.getElementById('practiceGrid');
            const cells = practiceGrid.querySelectorAll('.cell');
            const cellSize = 3;
            const cols = GRID_COLS;
            
            cells.forEach((cell, index) => {
                const x = (index % cols) * cellSize;
                const y = Math.floor(index / cols) * cellSize;
                
                if (cell.style.backgroundImage) {
                    certCtx.fillStyle = '#ccc';
                    certCtx.fillRect(x, y, cellSize - 0.5, cellSize - 0.5);
                }
            });
            
            certCtx.restore();
            
            // Watermark - diagonal
            certCtx.save();
            certCtx.translate(400, 300);
            certCtx.rotate(-Math.PI / 6);
            certCtx.font = 'bold 60px sans-serif';
            certCtx.fillStyle = 'rgba(0, 0, 128, 0.08)';
            certCtx.textAlign = 'center';
            certCtx.fillText('SQUARES DISCIPLINE', 0, 0);
            certCtx.fillText('NON REPRODUCTIBLE', 0, 70);
            certCtx.restore();
            
            // Footer watermark
            certCtx.font = '12px sans-serif';
            certCtx.fillStyle = '#999';
            certCtx.textAlign = 'center';
            certCtx.fillText('¬© Squares Exercise - Document unique et non reproductible', 400, 570);
            
            // Timestamp watermark (small, bottom right)
            certCtx.font = '10px monospace';
            certCtx.fillStyle = '#ccc';
            certCtx.textAlign = 'right';
            const timestamp = Date.now().toString(36).toUpperCase();
            certCtx.fillText(`ID: ${timestamp}`, 770, 590);
            
            return certCanvas;
        }

        function downloadCertificate() {
            const canvas = generateCertificate();
            const link = document.createElement('a');
            link.download = `squares-certificate-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function shareCertificate(platform) {
            const canvas = generateCertificate();
            canvas.toBlob((blob) => {
                const file = new File([blob], 'squares-certificate.png', { type: 'image/png' });
                
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({
                        title: 'J\'ai compl√©t√© l\'exercice Squares!',
                        text: `J'ai termin√© l'exercice de discipline "Squares" avec ${errorCount} erreur(s) !`,
                        files: [file]
                    }).catch(err => console.log('Partage annul√©', err));
                } else {
                    // Fallback: download
                    downloadCertificate();
                    alert('Partage non disponible sur ce navigateur.\nLe certificat a √©t√© t√©l√©charg√©.\nVous pouvez le partager manuellement sur ' + platform + '.');
                }
            });
        }

        function recognizeCharacter(expectedChar) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Extract features from the drawing
            const features = extractFeatures(data, canvas.width, canvas.height);
            
            // Character templates - basic pattern matching
            const templates = getCharacterTemplates();
            
            if (!templates[expectedChar]) {
                // If no template, accept (for special chars)
                return true;
            }
            
            // Compare with expected character template
            const similarity = compareFeatures(features, templates[expectedChar]);
            
            // Threshold for acceptance (60% similarity)
            return similarity > 0.6;
        }

        function extractFeatures(data, width, height) {
            const margin = 20;
            const centerX = width / 2;
            const centerY = height / 2;
            
            let topHalf = 0, bottomHalf = 0, leftHalf = 0, rightHalf = 0;
            let totalPixels = 0;
            let topMostY = height, bottomMostY = 0, leftMostX = width, rightMostX = 0;
            
            // Analyze the drawing
            for (let y = margin; y < height - margin; y++) {
                for (let x = margin; x < width - margin; x++) {
                    const index = (y * width + x) * 4;
                    if (data[index] < 200) { // Dark pixel
                        totalPixels++;
                        
                        if (y < centerY) topHalf++;
                        else bottomHalf++;
                        
                        if (x < centerX) leftHalf++;
                        else rightHalf++;
                        
                        if (y < topMostY) topMostY = y;
                        if (y > bottomMostY) bottomMostY = y;
                        if (x < leftMostX) leftMostX = x;
                        if (x > rightMostX) rightMostX = x;
                    }
                }
            }
            
            if (totalPixels === 0) return null;
            
            const heightRatio = (bottomMostY - topMostY) / (height - 2 * margin);
            const widthRatio = (rightMostX - leftMostX) / (width - 2 * margin);
            
            return {
                topHalf: topHalf / totalPixels,
                bottomHalf: bottomHalf / totalPixels,
                leftHalf: leftHalf / totalPixels,
                rightHalf: rightHalf / totalPixels,
                heightRatio,
                widthRatio,
                aspectRatio: widthRatio / heightRatio
            };
        }

        function getCharacterTemplates() {
            return {
                'A': { topHalf: 0.3, bottomHalf: 0.7, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                'B': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.7, rightHalf: 0.3, heightRatio: 0.8, widthRatio: 0.5, aspectRatio: 0.63 },
                'C': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.65, rightHalf: 0.35, heightRatio: 0.7, widthRatio: 0.6, aspectRatio: 0.86 },
                'D': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.65, rightHalf: 0.35, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                'E': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.7, rightHalf: 0.3, heightRatio: 0.8, widthRatio: 0.5, aspectRatio: 0.63 },
                'F': { topHalf: 0.6, bottomHalf: 0.4, leftHalf: 0.7, rightHalf: 0.3, heightRatio: 0.8, widthRatio: 0.5, aspectRatio: 0.63 },
                'G': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.6, rightHalf: 0.4, heightRatio: 0.7, widthRatio: 0.6, aspectRatio: 0.86 },
                'H': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                'I': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.2, aspectRatio: 0.25 },
                'J': { topHalf: 0.4, bottomHalf: 0.6, leftHalf: 0.3, rightHalf: 0.7, heightRatio: 0.8, widthRatio: 0.5, aspectRatio: 0.63 },
                'K': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.6, rightHalf: 0.4, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                'L': { topHalf: 0.4, bottomHalf: 0.6, leftHalf: 0.7, rightHalf: 0.3, heightRatio: 0.8, widthRatio: 0.5, aspectRatio: 0.63 },
                'M': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.8, aspectRatio: 1.0 },
                'N': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.7, aspectRatio: 0.88 },
                'O': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.7, widthRatio: 0.65, aspectRatio: 0.93 },
                'P': { topHalf: 0.6, bottomHalf: 0.4, leftHalf: 0.7, rightHalf: 0.3, heightRatio: 0.8, widthRatio: 0.5, aspectRatio: 0.63 },
                'Q': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.65, aspectRatio: 0.87 },
                'R': { topHalf: 0.55, bottomHalf: 0.45, leftHalf: 0.6, rightHalf: 0.4, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                'S': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.5, aspectRatio: 0.67 },
                'T': { topHalf: 0.55, bottomHalf: 0.45, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                'U': { topHalf: 0.4, bottomHalf: 0.6, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.6, aspectRatio: 0.8 },
                'V': { topHalf: 0.45, bottomHalf: 0.55, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.65, aspectRatio: 0.87 },
                'W': { topHalf: 0.45, bottomHalf: 0.55, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.85, aspectRatio: 1.13 },
                'X': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.7, aspectRatio: 0.88 },
                'Y': { topHalf: 0.55, bottomHalf: 0.45, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.65, aspectRatio: 0.81 },
                'Z': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.7, widthRatio: 0.6, aspectRatio: 0.86 },
                '0': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.6, aspectRatio: 0.8 },
                '1': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.4, rightHalf: 0.6, heightRatio: 0.8, widthRatio: 0.3, aspectRatio: 0.38 },
                '2': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.55, aspectRatio: 0.73 },
                '3': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.4, rightHalf: 0.6, heightRatio: 0.75, widthRatio: 0.5, aspectRatio: 0.67 },
                '4': { topHalf: 0.55, bottomHalf: 0.45, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.6, aspectRatio: 0.75 },
                '5': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.75, widthRatio: 0.5, aspectRatio: 0.67 },
                '6': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.55, rightHalf: 0.45, heightRatio: 0.75, widthRatio: 0.55, aspectRatio: 0.73 },
                '7': { topHalf: 0.6, bottomHalf: 0.4, leftHalf: 0.4, rightHalf: 0.6, heightRatio: 0.8, widthRatio: 0.55, aspectRatio: 0.69 },
                '8': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.5, rightHalf: 0.5, heightRatio: 0.8, widthRatio: 0.55, aspectRatio: 0.69 },
                '9': { topHalf: 0.5, bottomHalf: 0.5, leftHalf: 0.45, rightHalf: 0.55, heightRatio: 0.75, widthRatio: 0.55, aspectRatio: 0.73 }
            };
        }

        function compareFeatures(features, template) {
            if (!features) return 0;
            
            const weights = {
                topHalf: 0.15,
                bottomHalf: 0.15,
                leftHalf: 0.15,
                rightHalf: 0.15,
                heightRatio: 0.15,
                widthRatio: 0.15,
                aspectRatio: 0.1
            };
            
            let similarity = 0;
            
            for (let key in weights) {
                const diff = Math.abs(features[key] - template[key]);
                const score = Math.max(0, 1 - diff * 2); // More tolerant
                similarity += score * weights[key];
            }
            
            return similarity;
        }

        function cancelDrawing() {
            document.getElementById('drawingCanvas').classList.remove('active');
        }

        function startExercise() {
            const t = translations[currentLang];
            const input = document.getElementById('textInput').value.toUpperCase().replace(/[^A-Z0-9\s]/g, '');
            if (!input.trim()) {
                alert(t.enterText);
                return;
            }
            exerciseText = input;
            currentIndex = 0;
            errorCount = 0;
            window.exerciseStartTime = new Date();
            updateStatus();
            createGrid('practiceGrid', GRID_ROWS, GRID_COLS, true);
            document.getElementById('statusText').textContent = t.statusInProgress;
        }

        function resetGrid() {
            createGrid('practiceGrid', GRID_ROWS, GRID_COLS, true);
            currentIndex = 0;
            errorCount = 0;
            currentCell = null;
            updateStatus();
        }

        function updateStatus() {
            const t = translations[currentLang];
            document.getElementById('errorCount').textContent = `${t.errors} ${errorCount}`;
            if (exerciseText) {
                const progress = Math.min(100, Math.floor((currentIndex / totalCells) * 100));
                document.getElementById('statusText').textContent = `${t.statusProgress} ${progress}% (${currentIndex}/${totalCells})`;
            }
        }

        function generatePrintGrid() {
            const size = document.getElementById('gridSize').value;
            let rows, cols;
            
            switch(size) {
                case 'small': rows = 15; cols = 20; break;
                case 'large': rows = 25; cols = 35; break;
                default: rows = 20; cols = 27;
            }
            
            createGrid('printGrid', rows, cols, false);
        }

        createGrid('practiceGrid', GRID_ROWS, GRID_COLS, true);
        generatePrintGrid();
    </script>
</body>
</html>
